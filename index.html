<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.7.0/d3.min.js"
    integrity="sha512-cd6CHE+XWDQ33ElJqsi0MdNte3S+bQY819f7p3NUHgwQQLXSKjE4cPZTeGNI+vaxZynk1wVU3hoHmow3m089wA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"
    integrity="sha512-wNH6xsp2n8CfB91nrBtfc4sfLwYPBMjSWVUwQOp60AYYXH6i8yCwuKFZ4rgK2i6pQek/b+bSyR7b01/922IBzQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"
    integrity="sha512-4UKI/XKm3xrvJ6pZS5oTRvIQGIzZFoXR71rRBb1y2N+PbwAsKa5tPl2J6WvbEvwN3TxQCm8hMzsl/pO+82iRlg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-polygon@3"></script>
  <script src="./modules/utilities.js"></script>
  <link rel="stylesheet" href="./modules/stylesheet.css"></link>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
</style>
</head>

<body>
  <div class="title-container">
    <div class="title">Academic Proficiency by School and School Corporation for Indiana Schools</div>
  </div>

  <form>
    <div class="row twelve columns">
      <div class="top-level-navigation">

        <div class="dropdowns">
          <label for="scale" class="dropdown-label">Scale:</label>
          <select id="scale" name="scale" class="dropdown">
            <option value="Relative">Relative</option>
            <option value="Percentage">Percentage</option>
          </select>
          <label for="year" class="dropdown-label">Year:</label>
          <select id="year" name="year" class="dropdown">
            <option value="2024">2024</option>
            <option value="2023">2023</option>
            <option value="2022">2022</option>
            <option value="2021">2021</option>
            <option value="2019">2019</option>
          </select>
          <label for="subject" class="dropdown-label">Subject:</label>
          <select id="subject" name="subject" class="dropdown">
            <option value="ELA">ELA</option>
            <option value="Math">Math</option>
            <option value="ELA and Math">ELA and Math</option>
            <option value="IREAD">IREAD</option>
          </select>
        </div>

        <div class="navigation-div">
          <div class="category-label">Category:</div>
          <input type="radio" id="option-1n" name="navigation" value="by-grade" checked><label for="option-1n"
            class="btn btn-outline-primary">By Grade</label>
          <input type="radio" id="option-2n" name="navigation" value="by-ethnicity"><label for="option-2n"
            class="btn btn-outline-primary">By Race/Ethnicity</label>
          <input type="radio" id="option-3n" name="navigation" value="by-subgroup"><label for="option-3n"
            class="btn btn-outline-primary">By Subgroup</label>
        </div>

      </div>
    </div>

    <div class="subnavigation">
      <div id="by-grade-content">
        <div class="btn-group">
          <div class="subcategory-label">Sub-Category:</div>
          <div id="school-total">
            <input type="radio" id="option-1a" name="category-by-grade" value="School Total" checked><label
              for="option-1a" class="btn btn-outline-primary">School Total</label>
          </div>
          <div id="all-grades">
          <input type="radio" id="option-1b" name="category-by-grade" value="Grade 3"><label for="option-1b"
            class="btn btn-outline-primary">3</label>
          <input type="radio" id="option-1c" name="category-by-grade" value="Grade 4"><label for="option-1c"
            class="btn btn-outline-primary">4</label>
          <input type="radio" id="option-1d" name="category-by-grade" value="Grade 5"><label for="option-1d"
            class="btn btn-outline-primary">5</label>
          <input type="radio" id="option-1e" name="category-by-grade" value="Grade 6"><label for="option-1e"
            class="btn btn-outline-primary">6</label>
          <input type="radio" id="option-1f" name="category-by-grade" value="Grade 7"><label for="option-1f"
            class="btn btn-outline-primary">7</label>
          <input type="radio" id="option-1g" name="category-by-grade" value="Grade 8"><label for="option-1g"
            class="btn btn-outline-primary">8</label>
          </div>            
        </div>
      </div>

      <div id="by-ethnicity-content">
        <div class="btn-group">
          <label for="subnavigation" class="subcategory-label">Sub-Category:</label>
          <input type="radio" id="option-2a" name="category-by-ethnicity" value="American Indian" checked><label
            for="option-2a" class="btn btn-outline-primary">American Indian</label>
          <input type="radio" id="option-2b" name="category-by-ethnicity" value="Asian"><label for="option-2b"
            class="btn btn-outline-primary">Asian</label>
          <input type="radio" id="option-2c" name="category-by-ethnicity" value="Black"><label for="option-2c"
            class="btn btn-outline-primary">Black</label>
          <input type="radio" id="option-2d" name="category-by-ethnicity" value="Hispanic"><label for="option-2d"
            class="btn btn-outline-primary">Hispanic</label>
          <input type="radio" id="option-2e" name="category-by-ethnicity" value="Multiracial"><label for="option-2e"
            class="btn btn-outline-primary">Multiracial</label>
          <input type="radio" id="option-2f" name="category-by-ethnicity"
            value="Native Hawaiian or Other Pacific Islander"><label for="option-2f"
            class="btn btn-outline-primary">Pacific Islander</label>
          <input type="radio" id="option-2g" name="category-by-ethnicity" value="White"><label for="option-2g"
            class="btn btn-outline-primary">White</label>
        </div>
      </div>

      <div id="by-subgroup-content">
        <div class="btn-group">
          <label for="subnavigation" class="subcategory-label">Sub-Category:</label>
          <input type="radio" id="option-3a" name="category-by-subgroup" value="English Language Learners"
            checked><label for="option-3a" class="btn btn-outline-primary">English Learners</label>
          <input type="radio" id="option-3b" name="category-by-subgroup" value="Non English Language Learners"><label
            for="option-3b" class="btn btn-outline-primary">Non English Learners</label>
          <input type="radio" id="option-3c" name="category-by-subgroup" value="General Education"><label
            for="option-3c" class="btn btn-outline-primary">General Education</label>
          <input type="radio" id="option-3d" name="category-by-subgroup" value="Special Education"><label
            for="option-3d" class="btn btn-outline-primary">Special Education</label>
          <input type="radio" id="option-3e" name="category-by-subgroup" value="Free or Reduced Price Meals"><label
            for="option-3e" class="btn btn-outline-primary">Free or Reduced Price Meals</label>
          <input type="radio" id="option-3f" name="category-by-subgroup" value="Paid Meals"><label for="option-3f"
            class="btn btn-outline-primary">Paid Meals</label>
        </div>
      </div>
    </div>
  </div>

  </form>

  <div class="main-container">
    <div class="bare-container--flex--center twelve columns">
      <div class="pretty-container--close--top twelve columns">
        <div class="map-container">
          <div class="map"></div>
        </div>
      </div>
    </div>
  </div>

<script>
// Indiana School Map
// revised: 10.17.24
// https://github.com/jbetley

const replacementText = [
  { name: "Non English Language Learners", new: "Non EL" },
  { name: "English Language Learners", new: "EL" },
  { name: "Free or Reduced Price Meals", new: "FRL" },
  { name: "General Education", new: "Gen Ed" },
  { name: "Special Education", new: "Special Ed" }
];

// display grade-content on load (default css is display none)
document.getElementById("by-grade-content").style.display = "block";

// TODO: Modify Navigation to be Dynamic //
var subNavigation = document.querySelector(".navigation-div");

var previousSelection = d3.select("#subject")._groups[0][0].value

// this prevents a drag from registering as a click
subNavigation.addEventListener('mousemove', function(e) {
     isBetweenDragAndClick = true;
 });

subNavigation.addEventListener("click", function (e) {

  if(isBetweenDragAndClick) {
      isBetweenDragAndClick = false;
      return;
  }

  // this prevents click from registering on the div container holding
  // the buttons
  if (e.target.nodeName != "DIV") {
    //  on click, display target content id and set rest to none
    var divs = document.querySelectorAll('div.subnavigation > div');

    for (let div of divs) {
      div.style.display = "none";
    }

    if (e.target.value) {
      target_div = e.target.value + "-content"
      document.getElementById(target_div).style.display = "block";
    }
  }
});

function zoomed(event) {
  const { transform } = event;
  svg.attr("transform", transform);
  svg.attr("stroke-width", 1 / transform.k);
}

// resets selection when the same node is clicked twice
function reset() {
  active.classed("active", false);

  svg.selectAll(".points")
    .transition()
    .duration(500)
    .remove();

  svg.transition()
    .duration(750)
    .call(zoom.transform, d3.zoomIdentity);
}

function stopped(event, d) {
  if (event.defaultPrevented) event.stopPropagation();
}

// Map //
var width = 800,
  height = 800,
  colorHistory = [],
  points,
  colors,
  legend,
  updateColor,
  active = d3.select(null);

var tooltip = d3.select("body").append("div")
  .attr("class", "tooltip")
  .style("opacity", 0);

var svg = d3.select(".map")
  .append("svg")
  .attr("width", width)
  .attr("height", height)
  .append("g");

var leg = svg.append("g")
  .attr("class", "legend-threshold")
  .attr("transform", "translate(20,80)");

leg.append("text")
  .attr("font-weight", "bold")
  .attr("class", "caption")
  .attr("x", 0)
  .attr("y", -6)
  .style("fill", "steelblue")
  .text("Percentage Proficient");

var mapTitle = svg.append("g")
  .attr("class", "map-title")
  .attr("transform", "translate(180,5)");

mapTitle.append("rect")
  .attr('width', 350)
  .attr('height', 20)
  .style("fill", "white")
  .style("pointer-events", "visible")

var schoolTop = svg.append("g")
  .attr("class", "top-schools")
  .attr("transform", "translate(565,40)");

schoolTop.append("rect")
  .attr('width', 220)
  .attr('height', 20)
  .attr("rx", function (d) { return 5 })
  .attr("ry", function (d) { return 5 })
  .style("stroke", "steelblue")
  .style("fill", "steelblue")
  .style("pointer-events", "visible")

var corpTop = svg.append("g")
  .attr("class", "top-corps")
  .attr("transform", "translate(565,80)");

corpTop.append("rect")
  .attr('width', 220)
  .attr('height', 20)
  .attr("rx", function (d) { return 5 })
  .attr("ry", function (d) { return 5 })
  .style("stroke", "steelblue")
  .style("fill", "steelblue")
  .style("pointer-events", "visible")

var schoolGaps = svg.append("g")
  .attr("class", "school-gaps")
  .attr("transform", "translate(565,120)");

schoolGaps.append("rect")
  .attr('width', 220)
  .attr('height', 20)
  .attr("rx", function (d) { return 5 })
  .attr("ry", function (d) { return 5 })
  .style("stroke", "steelblue")
  .style("fill", "steelblue")
  .style("pointer-events", "visible");

var corpGaps = svg.append("g")
  .attr("class", "corp-gaps")
  .attr("transform", "translate(565,160)");

corpGaps.append("rect")
  .attr('width', 220)
  .attr('height', 20)
  .attr("rx", function (d) { return 5 })
  .attr("ry", function (d) { return 5 })
  .style("stroke", "steelblue")
  .style("fill", "steelblue")
  .style("pointer-events", "visible");

var zoom = d3.zoom()
  .scaleExtent([1, 8])
  .on("zoom", zoomed);

Promise.all([
  d3.csv("corporation_data_k8_public.csv"),
  d3.csv("school_data_k8_public.csv"),
  d3.json("corporation_geojson.json"),
  d3.json("school_geojson.json"),      
]).then(function ([scdata, schdata, INdistricts, INschools]) {

  const districts = topojson.feature(INdistricts, INdistricts.objects.districts);
  const schools = topojson.feature(INschools, INschools.objects.publicschools);
  const mesh = topojson.mesh(INdistricts, INdistricts.objects.districts);
  const projection = d3.geoMercator().fitSize([width, height], mesh);

  var path = d3.geoPath().projection(projection);

  var paths = svg.append("g")
    .attr("class", "districts")
    .selectAll("path")
    .data(districts.features)
    .enter().append("path")
    .attr('data-fips', function (d) {
      return d.properties.NAME
    })
    .attr("d", path)
    .attr("transform", "translate(-100,30)");

  var updateMap = function (scale, year, subject, category) {

    // scale defaults to Relative for all Categories except IREAD,
    // which cannot select Relative
    if (scale == 'Relative' && d3.select("#subject.dropdown").node().value != "IREAD") {
      selectedDomain = [.10, .15, .25, .35, .45, .55, .65, .75];
      labels = ['0-10%', '11-15%', '16-25%', '26-35%', '36-45%', '46-55%', '55-65%', '66-75%', '> 76%'];
    }
    else {
      selectedDomain = [.20, .30, .40, .50, .60, .70, .80, .90];
      labels = ['0-20%', '21-30%', '31-40%', '41-50%', '51-60%', '61-70%', '71-80%', '81-90%', '> 91%'];

    if (d3.select("#subject.dropdown").node().value == "IREAD") {
        const radioBtn = document.getElementById("scale"); 
        radioBtn.value = "Percentage"
      }
    }

    color = d3.scaleThreshold()
      .domain(selectedDomain)
      .range(["#e5eff9", "#cee1f2", "#b0d1e7", "#87bddc", "#5da4d0", "#3a89c1", "#1d6bb0", "#0e559d", "#08306b"]);

    legend = d3.legendColor()
      .labels(function (d) { return labels[d.i]; })
      .shapePadding(4)
      .scale(color);
    svg.select(".legend-threshold")
      .call(legend);

    var schoolData = schdata.filter(obj => {
      return obj.Year === year
    })

    var corpData = scdata.filter(obj => {
      return obj.Year === year
    })

    // Top 10 Schools and Corps
    const proficiencyCategory = category + "|" + subject + " Proficiency %";
    var nSizeCategory;
    var totalProficient;

    if (d3.select("#subject.dropdown").node().value == "IREAD") {

      nSizeCategory = category + "|" + subject + " Test N";
      totalProficient = category + "|" + subject + " Pass N";
    
    } else {
      nSizeCategory = category + "|" + subject + " Total Tested";
      totalProficient = category + "|" + subject + " Total Proficient";          
    }

    // calculate state average for each category
    // NOTE: This is much harder than it sounds for certain categories due
    // to the large number of redactions due to insufficient n-size - for
    // example: we are unable to generate an average at all for American
    // Indian using school data because no school has a sufficiently large
    // American Indian population to generate a value. We can generate an
    // average using aggregated corporation data, but it is also skewed
    // because tested students show up in the denominator but not in
    // the numerator (e.g., the numerator is "***") - so perhaps best case
    // scenario is to disregard all rows with a total proficiency of "***".
    // the final number still will not be completely accurate, but it is
    // probably the best we can do.

    const adjustedData = corpData.filter(function (el) {
      return el[totalProficient] != "***" && el[totalProficient] != ""
    });

    const sumTested = d3.sum(adjustedData, d => d[nSizeCategory]);
    const sumProficient = d3.sum(adjustedData, d => d[totalProficient]);

    const stateAverage = sumProficient / sumTested

    d3.select('.map-title-text').remove()

    mapTitle = d3.select(".map-title")
      .append("text")
      .attr("font-weight", "bold")
      .attr("font-size", "14px")
      .attr("class", "map-title-text")
      .style("pointer-events", "visible")
      .style("fill", "steelblue")
      .attr("dx", function (d) { return 6 })
      .attr("dy", function (d) { return 13 })
      .style("opacity", 1)
      .text(proficiencyCategory + " (State Average: " + calc_percent(stateAverage) + ")");

    d3.select('.top-schools .infobar-text').remove()

    schoolTop = d3.select(".top-schools")
      .append("text")
      .attr("font-weight", "bold")
      .attr("font-size", "10px")
      .attr("font-family", "Inter, sans-serif")
      .attr("class", "infobar-text")
      .style("pointer-events", "visible")
      .attr("text-anchor", "middle")
      .attr("dominant-baseline", "middle")
      .attr("dx", 110)
      .attr("dy", 11)
      .style("fill", "white")
      .text("Highest Proficiency: Schools");

    schoolTop.on("mouseover", function (event, d) {
      let pos = d3.select(this).node().getBoundingClientRect();

      const nSizeSchool = schoolData.filter(d => +d[nSizeCategory] > 10);
      const schoolProficiency = nSizeSchool.filter(d => isNumeric(d[proficiencyCategory]));

      // Sort by proficiency and then nSize
      schoolProficiency.sort(function (a, b) {
        return +a[proficiencyCategory] - +b[proficiencyCategory] ||
          +a[nSizeCategory] - +b[nSizeCategory];
      });

      schoolTopTen = schoolProficiency.slice(schoolProficiency.length - 10);

      let j = 0,
        schoolText = [];

      for (k = schoolTopTen.length - 1; k >= 0; k--) {

        schoolText[j] = j + 1 + ") <b>" + schoolTopTen[k]['School Name'] + "</b>: <b>" +
          calc_percent(schoolTopTen[k][proficiencyCategory]) + "</b> (n-size: " +
          schoolTopTen[k][nSizeCategory] + ")<br/> (" + schoolTopTen[k]['Corporation Name'] + ")."
        j++

        tooltip.html(schoolText.join('<br/><br/>'))
          .style('left', `${pos['x'] - 1}px`)
          .attr("id", "popup-box")
          .style('top', `${(window.pageYOffset + pos['y'] + 39)}px`)
          .style("opacity", 1);
      }
    })
      .on('mouseout', function (d) {
        d3.select(this).classed("selected", false);
        d3.selectAll('.tooltip')
          .style("opacity", 0)
      });

    d3.select('.top-corps .infobar-text').remove()

    schoolTop = d3.select(".top-corps")
      .append("text")
      .attr("font-weight", "bold")
      .attr("font-size", "10px")
      .attr("class", "infobar-text")
      .attr("text-anchor", "middle")
      .attr("dominant-baseline", "middle")
      .attr("dx", 110)
      .attr("dy", 11)
      .style("fill", "white")
      .style("pointer-events", "visible")
      .text("Highest Proficiency: Corporations");

    corpTop.on("mouseover", function (event, d) {

      let pos = d3.select(this).node().getBoundingClientRect();

      const corpProficiency = corpData.filter(d => isNumeric(d[proficiencyCategory]));

      corpProficiency.sort(function (a, b) {
        return +a[proficiencyCategory] - +b[proficiencyCategory] ||
          +a[nSizeCategory] - +b[nSizeCategory];
      });

      corpTopTen = corpProficiency.slice(corpProficiency.length - 10);

      let j = 0,
        corpText = [];

      for (k = corpTopTen.length - 1; k >= 0; k--) {

        corpText[j] = j + 1 + ") <b>" + corpTopTen[k]['Corporation Name'] + "</b>: <b>" +
          calc_percent(corpTopTen[k][proficiencyCategory]) + "</b> (n-size: " +
          corpTopTen[k][nSizeCategory] + ")."

        j++

        tooltip.html(corpText.join('<br/><br/>'))
          .style('left', `${pos['x'] - 1}px`)
          .attr("id", "popup-box")
          .style('top', `${(window.pageYOffset + pos['y'] + 39)}px`)
          .style("opacity", 1);
      }
    })
      .on('mouseout', function (d) {
        d3.select(this).classed("selected", false);
        d3.selectAll('.tooltip')
          .style("opacity", 0)
      });

    // Achievement Gaps (currently limited to the following catagories)
    if (category == "Black" || category == "Multiracial" || category == "Hispanic"
      || category == "Asian" || category == "Paid Meals" || category == "Free or Reduced Price Meals"
      || category == "Non English Language Learners" || category == "English Language Learners"
      || category == "Special Education" || category == "General Education") {

      d3.select('.school-gaps .infobar-text').remove()

      schoolGaps = d3.select(".school-gaps")
        .append("text")
        .attr("font-weight", "bold")
        .attr("font-size", "10px")
        .attr("class", "infobar-text")
        .attr("text-anchor", "middle")
        .attr("dominant-baseline", "middle")
        .attr("dx", 110)
        .attr("dy", 11)
        .style("fill", "white")
        .style("pointer-events", "visible")
        .text("Largest Achievement Gaps: Schools")
        .style("display", "block")

      schoolGaps.on("mouseover", function (event, d) {
        let pos = d3.select(this).node().getBoundingClientRect();

        schoolGapLong = calculateGap(schoolData, subject, category)

        if (typeof schoolGapLong == 'undefined') { return }

        let j = 0,
          schoolGapText = [];

        schoolGap = shortenNames(schoolGapLong, replacementText)

        for (k = schoolGap.length - 1; k >= 0; k--) {

          // school achievement gap popup window
          schoolGapText[j] = j + 1 + ") <b>" + schoolGap[k]["School Name"] + "</b>: <b>" +
            calc_percent(schoolGap[k]["Difference"]) + "</b><br/>" + schoolGap[k]["Corporation Name"] +
            "<br/>(" + schoolGap[k]["First Name"] + ": " + calc_percent(schoolGap[k]["First"]) +
            " - " + schoolGap[k]["Second Name"] + ": " + calc_percent(schoolGap[k]["Second"]) + ")."
          j++

          tooltip.html(schoolGapText.join('<br/><br/>'))
            .style('left', `${pos['x'] - 1}px`)
            .attr("id", "popup-box")
            .style('top', `${(window.pageYOffset + pos['y'] + 39)}px`)
            .style("opacity", 1)
        }
      })
        .on('mouseout', function (d) {
          d3.select(this).classed("selected", false);
          d3.selectAll('.tooltip')
            .style("opacity", 0)
        });

      // achievement gaps - corporations
      d3.select('.corp-gaps .infobar-text').remove()

      corpGaps = d3.select('.corp-gaps')
        .append("text")
        .attr("font-weight", "bold")
        .attr("font-size", "10px")
        .attr("class", "infobar-text")
        .attr("text-anchor", "middle")
        .attr("dominant-baseline", "middle")
        .attr("dx", 110)
        .attr("dy", 11)
        .style("fill", "white")
        .style("pointer-events", "visible")
        .text("Largest Achievement Gaps: Corporations")
        .style("display", "block");

      corpGaps.on("mouseover", function (event, d) {
        let pos = d3.select(this).node().getBoundingClientRect();

        corpGapLong = calculateGap(corpData, subject, category)

        if (typeof corpGapLong == 'undefined') { return }

        corpGap = shortenNames(corpGapLong, replacementText)

        let j = 0,
          corpGapText = [];

        for (k = corpGap.length - 1; k >= 0; k--) {

          // corporation achievement gap popup window
          corpGapText[j] = j + 1 + ") <b>" + corpGap[k]["Corporation Name"] + "</b>: <b>" +
            calc_percent(corpGap[k]["Difference"]) + "</b><br/> (" + corpGap[k]["First Name"] +
            ": " + calc_percent(corpGap[k]["First"]) + " - " + corpGap[k]["Second Name"] + ": " +
            calc_percent(corpGap[k]["Second"]) + ")."
          j++

          tooltip.html(corpGapText.join('<br/><br/>'))
            .style('left', `${pos['x'] - 1}px`)
            .attr("id", "popup-box")
            .style('top', `${(window.pageYOffset + pos['y'] + 39)}px`)
            .style("opacity", 1);
        }
      })
        .on('mouseout', function (d) {
          d3.select(this).classed("selected", false);
          d3.selectAll('.tooltip')
            .style("opacity", 0)
        });

      d3.selectAll('.school-gaps').style("display", "block")
      d3.selectAll('.corp-gaps').style("display", "block")
    }

    else {
      d3.selectAll('.school-gaps').style("display", "none")
      d3.selectAll('.corp-gaps').style("display", "none")
    }

    // the map is translated 100px left and 50px down, so all other objects
    // must be shifted the same amount in order to line up correctly
    // (especially during zoom, where we need to multiply the shift by
    // the scale factor)
    paths = d3.select('.districts')
      .selectAll("path")
      .data(districts.features)
      .attr('data-fips', function (d) { return d.properties.NAME })
      .attr("d", path)
      .attr("transform", "translate(-100,30)")
      .attr("fill", function (d, i) {

        const data = corpData.find(f => f['Corporation ID'] === d.properties.CORPID)

        console.log(data)
        
        // value will be null if the school corporation does not exist
        // exist or was created (e.g., West Clark Community Schools
        // dissolved in 2020 and Borden-Henryville was formed
        if (data == null) { fillColor = "grey" }

        else if (data[proficiencyCategory] == "" || data[proficiencyCategory] == "***" ||
          isNaN(data[proficiencyCategory])) { fillColor = "grey" }

        else {

          fillColor = color(data[proficiencyCategory])

        }
        return fillColor
      })
      .attr("stroke", "white")
      .on("click", clicked)
      .on('mouseover', function (event, d) {

        let pos = d3.select(this).node().getBoundingClientRect();

        d3.select(this).classed("selected", true);

        const data = corpData.find(f => f['Corporation ID'] === d.properties.CORPID)

        // hide the district level tooltip when zoomed, but only for the "active"
        // district - show other districts when zoomed

        // svg._groups[0][0].__zoom.k gives us the "k" transform value, aka the
        // current zoom amount. so tooltips are only shown if k == 1 (it is not zoomed in)
        // add the test for null to prevent an error on load or reload where the val is null
        if ((data != null) && ((svg._groups[0][0].__zoom == null)
          || (svg._groups[0][0].__zoom.k == 1))) {

          // adjust position of district tooltip based on width
          // of the rect
          if (pos["width"] > 15) {
            addWidth = pos["width"] / 2
          }
          else {
            addWidth = 0
          }

          xPos = pos["x"] + addWidth + 20
          yPos = pos["y"]

          tooltip.html(
            data['Corporation Name'] + "<br>" + proficiencyCategory.slice(0, -2) +
            ": " + calc_percent(data[proficiencyCategory]) + "<br>Total Tested: " +
            data[nSizeCategory]
          )
            .style('left', `${xPos}px`)
            .style('top', `${(window.pageYOffset + yPos)}px`)
            .style("opacity", 1);
        }

        // when zoomed, hide zoomed district tooltip, but show all others
        else if ((svg._groups[0][0].__zoom.k > 1) && (active.node() != this)) {

          xPos = event.offsetX
          // prevent tooltip from appearing outside of map boundaries
          // base on how close mouse is to top of the screen,
          // taking into consideration how much of the header
          // is currently displayed (due to scroll)

          // if mouse "enters" a rect < 85 pixels from the top of the screen (including
          // the amount of header currently displayed due to scroll), shift the tip 100px
          // down. prevents it from appearing outside of map
          let headerHeight = d3.select("body").node().getBoundingClientRect().height + 16;
          const visibleHeader = headerHeight - window.scrollY
          const shiftTip = event.clientY - visibleHeader
          if (shiftTip < 85) {
              yPos = event.offsetY + 120
          }
          else {
              yPos = event.offsetY + 20
          }

          tooltip.html(
            data['Corporation Name'] + "<br>" + proficiencyCategory.slice(0, -2) +
            ": " + calc_percent(data[proficiencyCategory]) + "<br>Total Tested: " +
            data[nSizeCategory]
          )
            .style("left", (xPos) + "px")
            .style("top", (yPos) + "px")
            .style("opacity", 1);
        }
      })
      .on('mouseout', function (event, d) {
        d3.select(this).classed("selected", false);
        tooltip.style("opacity", 0)
      });

    // if category is changed while zoomed (e.g., k > 1), change point
    // colors to reflect new values, and update tooltip values
    if (svg._groups[0][0].__zoom != null) {
      if (svg._groups[0][0].__zoom.k > 1) {

        // change color of the schools (circles)
        svg.selectAll("circle").style("fill", function (d) {

          const data = schoolData.find(f => +f['School ID'] === +d.schoolId)

          if (data == null) { return "grey" }

          if (data[proficiencyCategory] === "" || data[proficiencyCategory] === "***" 
            || isNaN(data[proficiencyCategory]) || data[proficiencyCategory] == null) {
            return "#ffffff"
          }
          else {
            return color(data[proficiencyCategory])
          }
        })
          .on('mouseover', function (event, d) {

            let pos = d3.select(this).node().getBoundingClientRect();

            d3.select(this).classed("selected", true);

            const data = schoolData.find(f => +f['School ID'] === +d.schoolId)

            if (data != null) {

              tooltip.html(
                data['School Name'] + "<br>" + proficiencyCategory.slice(0, -2) + ": " + calc_percent(data[proficiencyCategory]) + "<br>Total Tested: " + data[nSizeCategory]
              )
                .style('left', `${pos['x'] + 20}px`)
                .style('top', `${(window.pageYOffset + pos['y'] - 20)}px`)
                .style("opacity", 1);
            }
          })
          .on('mouseout', function (d) {
            d3.select(this).classed("selected", false);
            tooltip.style("opacity", 0)
          });

        points.transition().duration(800).style("opacity", .7);
      }
    };

    // ensure that points are on top of fill
    svg.selectAll(".points").raise()

    function clicked(event, d) {

      // at this point, active.node() is equal to the selected node
      // immediately before the click. So if active.node() is equal
      // to "this", it means the same node was clicked twice. Otherwise
      // a different node was clicked.
      if (active.node() === this) return reset();

      // clear active status from previous school and add to current school
      d3.select('.active').classed("active", false);
      active = d3.select(this).classed("active", true);

      // NOTE: Not sure what I was doing here //
      // TODO: Testing color blend. Previous effect worked because it was
      // layering another path on top of the first with a low opacity (not
      // sure if this was intended - because it eventually got slow as hell)
      // probably easier and faster to use css to 'blend' colors
      // cur_color = d3.select(".active").attr("fill")
      // console.log(d3.selectAll(".districts").select(".active"))
      // d3.select('.active')
      //   .append("g")
      //   .enter().append("path")
      //   .style("fill", cur_color)
      //   .style("opacity", .8)

      // get the LEAID of the active (selected) node

      activeDistrictLEAID = active.data()[0].properties.GEOID

      var bounds = path.bounds(d),
        dx = bounds[1][0] - bounds[0][0],
        dy = bounds[1][1] - bounds[0][1],
        x = (bounds[0][0] + bounds[1][0]) / 2,
        y = (bounds[0][1] + bounds[1][1]) / 2,
        scale = Math.max(1, Math.min(10.5, 1 / Math.max(dx / width, dy / height))), // Size of zoomed district
        translate = [width / 2 - scale * x, height / 2 - scale * y];

      // map is shifted (-100,30). in order to account for this, we need
      // to translate the zoom, but first we need to multiple it by the
      // scale. Adding fifty seems to center the districts a bit
      // better. if scale changes, need to to re-examine the appropriate
      // x and y shift values
      let xshift = (scale * 100) + 50
      let yshift = (scale * 30) + 50

      svg.transition()
        .duration(750)
        .call(zoom.transform, d3.zoomIdentity.translate(translate[0] + xshift, translate[1] - yshift).scale(scale));

      var schoolsInPOLY = schools.features.filter(function (s) {
        if (d3.polygonContains(active.datum().geometry.coordinates[0], [s.geometry.coordinates[0], s.geometry.coordinates[1]])) {

          // TODO: add High School Academic Data
          const max = 9;
          const min = 2;
          var low;

          // filter points by characteristic (hides schools we do not want
          // to display. we also check to make sure that all points are
          // contained within the same LEIAD as the active district - this
          // makes sure we do not display schools that are located in another
          // district that the geographically located wholly inside the
          // selected district
          if (s.properties.GSLO == 'PK' || s.properties.GSLO == 'KG') { low = 0 } else { low = parseInt(s.properties.GSLO) }

          if ((
            low < max && s.properties.GSHI > min) &&
            ((s.properties.LEAID == activeDistrictLEAID) || (s.properties.CHARTER_TEXT == "1-Yes"))
            && (s.properties.SCHOOL_LEV != "CLOSED" && s.properties.SCHOOL_LEV != "Cooperative"
              && s.properties.SCHOOL_LEV != "Other" && s.properties.SCHOOL_LEV != "Special Education"
              && s.properties.SCHOOL_LEV != "Adult High School"
            )) {

            return s.properties.LEAID
          }
        }
      })

      var schoolsInDist = { type: "FeatureCollection", "features": schoolsInPOLY };

      // Remove existing points each click (otherwise points
      // keep propagating until reset event)
      svg.selectAll(".points")
        .transition()
        .duration(200)
        .remove();

      // calculate radius of individual points based on the number of
      // schools and the area per school of each district (this is
      // somewhat arbitrary, but is needed to prevent weird outliers)
      districtSize = dx * dy

      numberOfSchools = schoolsInDist.features.length
      areaPerSchool = districtSize / numberOfSchools

      if (numberOfSchools <= 5) {
        if (areaPerSchool <= 25) {
          rad = .75
        }
        else if (areaPerSchool > 25 & areaPerSchool <= 50) {
          rad = 1
        }
        else if (areaPerSchool > 50 & areaPerSchool <= 100) {
          rad = 1.5
        }
        else {
          rad = 2
        }
      }
      else if (numberOfSchools > 5 & numberOfSchools <= 12) {
        if (areaPerSchool <= 40) {
          rad = .75
        }
        else if (areaPerSchool > 40 & areaPerSchool <= 80) {
          rad = 1
        }
        else if (areaPerSchool > 80 & areaPerSchool <= 200) {
          rad = 1.5
        }
        else {
          rad = 2
        }
      }
      else if (numberOfSchools > 12 & numberOfSchools <= 16) {
        if (areaPerSchool <= 25) {
          rad = .75
        }
        else if (areaPerSchool > 25 & areaPerSchool <= 100) {
          rad = 1
        }
        else if (areaPerSchool > 100 & areaPerSchool <= 500) {
          rad = 1.5
        }
        else {
          rad = 2
        }
      }
      else if (numberOfSchools > 16) {
        if (areaPerSchool <= 40) {
          rad = .75
        }
        else if (areaPerSchool > 40 & areaPerSchool <= 100) {
          rad = 1
        }
        else {
          rad = 1.5
        }
      }

      // get points located within the geographic coordinates
      group = schoolsInDist.features.map(o => ({
        x: projection(o.geometry.coordinates)[0],
        y: projection(o.geometry.coordinates)[1],
        r: rad,
        schoolId: o.properties.SCHOOL_ID
      }))

      // points can be on top of each other, so we use the shifty()
      // function to spread out circles whenever points overlap
      // NOTE: a second call to shifty pushes points out farther, but
      // starts to distort locations. more than 2 calls and points
      // get pushed outside of district boundaries
      shifty(group);

      points = svg.append("g")
        .attr('class', 'points')
        .selectAll("circle")
        .data(group)
        .enter()
        .append("circle")
        .attr("cx", function (d) { return d.x })
        .attr("cy", function (d) { return d.y })
        .attr("r", function (d) { return d.r })
        .attr("transform", "translate(-100,30)") // map shift
        .style("stroke", "white")
        .attr("fill", function (d) {

          const data = schoolData.find(f => +f['School ID'] === +d.schoolId)

          if (data == null) { return "grey" }

          if (data[proficiencyCategory] === "" || data[proficiencyCategory] === "***" 
          || isNaN(data[proficiencyCategory]) || data[proficiencyCategory] == null) {
            return "#ffffff"
          }
          else {
            return color(data[proficiencyCategory])
          }
        })
        .style("opacity", 0)
        .on('mouseover', function (event, d) {

          let pos = d3.select(this).node().getBoundingClientRect();

          // the selected class is only used to detect which path
          // the mouse is currently over - or out of
          d3.select(this).classed("selected", true);

          const data = schoolData.find(f => +f['School ID'] === +d.schoolId)

          if (data != null) {

            tooltip.html(
              data['School Name'] + "<br>" + proficiencyCategory.slice(0, -2) + ": " + calc_percent(data[proficiencyCategory]) + "<br>Total Tested: " + data[nSizeCategory]
            )
              .style('left', `${pos['x'] + 20}px`)
              .style('top', `${(window.pageYOffset + pos['y'] - 30)}px`)
              .style("opacity", 1);
          }
        })
        .on('mouseout', function (d) {
          d3.select(this).classed("selected", false);
          tooltip.style("opacity", 0)
        });

      points.transition().duration(1000).style("opacity", .7);
    }
  }

  // update map on change on any select or input element
  d3.selectAll("input, select").on("change", function () {

    var selectedScale = d3.select("#scale").node().value
    var selectedYear = d3.select("#year").node().value
    var selectedSubject = d3.select("#subject").node().value

    // only display school-total for by-grade for IREAD (option-1n is the 
    // "by-grade-content" button)
    if (document.getElementById('option-1n').checked) {

      if (selectedSubject == "IREAD") {
        document.getElementById("school-total").style.display = "block";
        document.getElementById("all-grades").style.display = "none";
      } else {
        document.getElementById("school-total").style.display = "block";
        document.getElementById("all-grades").style.display = "block";
      }
    }
    else {
      document.getElementById("by-grade-content").style.display = "none";
    }

    var selectedNav = d3.select("input[name='navigation']:checked").attr('value');

    subNavigation = "category-" + selectedNav
    var selectedCategory = d3.select("input[name=" + subNavigation + "]:checked").attr('value');

    // if user switches from IREAD to any other category, scale
    // switches back to Relative
    if (previousSelection == "IREAD" && selectedSubject != "IREAD") {
      selectedScale = "Relative"
      document.getElementById("scale").value = "Relative"; 
    }
    previousSelection = selectedSubject

    updateMap(selectedScale, selectedYear, selectedSubject, selectedCategory)
  })

  updateMap('Relative', '2024', 'ELA', 'School Total')

}).catch(function (error) {
  console.error(error);
})

</script>
</body>
</html>