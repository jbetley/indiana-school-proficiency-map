<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.7.0/d3.min.js"
    integrity="sha512-cd6CHE+XWDQ33ElJqsi0MdNte3S+bQY819f7p3NUHgwQQLXSKjE4cPZTeGNI+vaxZynk1wVU3hoHmow3m089wA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"
    integrity="sha512-wNH6xsp2n8CfB91nrBtfc4sfLwYPBMjSWVUwQOp60AYYXH6i8yCwuKFZ4rgK2i6pQek/b+bSyR7b01/922IBzQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.js"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"
    integrity="sha512-4UKI/XKm3xrvJ6pZS5oTRvIQGIzZFoXR71rRBb1y2N+PbwAsKa5tPl2J6WvbEvwN3TxQCm8hMzsl/pO+82iRlg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.js"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/d3-polygon@3"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    body {
      background: #dbdbdb;
      font-family: 'Inter', sans-serif;
      color: steelblue
    }

    span {
      font-family: 'Inter', sans-serif;
      color: steelblue
    }

    h2 {
      background: linear-gradient(to right, steelblue 20%, #FFF 20%) bottom .5em left .8em no-repeat, linear-gradient(steelblue, #dbdbdb);
      background-size: 100% 1px, 100% 100%;
      padding: .8em;
      color: #FDFFFE;
      font-size: 30px;
      font-weight: lighter;
      margin-bottom: 10px;
    }

    div.tooltip {
      position: absolute;
      text-align: center;
      width: 310px;
      padding: 2px;
      font: 11px 'Inter', sans-serif;
      font-weight: bold;
      background: #e3e3e3;
      color: steelblue;
      border-radius: 8px;
      border: thin solid steelblue;
      pointer-events: none;
    }


    table {
      border: thin solid steelblue;
      border-radius: 5px;
      height: 300px;
      width: 300px;
    }

    th,
    td {
      padding: 3px;
      border: thin solid steelblue;
      border-radius: 5px;
    }

    th {
      text-align: center;
    }

    .top {
      border: thin solid steelblue;
      border-radius: 5px;
      margin-left: 10px;
      margin-bottom: 10px;
    }

    input[type=radio] {
      position: absolute;
      visibility: hidden;
      display: none;
    }

    label {
      font-size: 10px;
      border: solid 1px #699bc4;
      border-radius: 10px;
      color: steelblue;
      /*color: #8eb4d3;*/
      background: #e3e3e3;
      display: inline-block;
      cursor: pointer;
      font-weight: bold;
      padding: 7px 7px;
      margin: 2px;
    }

    input[type=radio]:checked+label {
      color: #dbdbdb;
      background: #699bc4;
    }

    .radio-group {
      display: inline-block;
      overflow: hidden;
      margin-left: 5px;
      margin-right: 5px;
      margin-top: 5px;
    }

    .map-container {
      margin-left: 10px;
      float: left;
      height: 100%;
      width: 100%;
      border-radius: 5px;
      border: thin solid steelblue;
      overflow: visible;
    }

    .map {
      float: left;
      margin-left: 20px;
      margin-top: 20px;
      width: 100%;
      height: 100%;
    }

    .stats {
      position: absolute;
      left: 700px;
      top: 270px;
      width: 350px;
      font-family: 'Inter', sans-serif;
      font-size: .6em;
      line-height: 1.5em;
      background: #e3e3e3;
      font-weight: bold;
      float: left;
      border: thin solid steelblue;
      padding: 3px;
      border-radius: 5px;
    }

    .legendThreshold {
      font-size: 10px;
      font-family: 'Inter', sans-serif;
    }

    /* This controls the color of the school corporations when selected */
    .active {
      fill: #dbdbdb;
      /* fill: #B97D4B; */
      opacity: .8;
    }
  </style>
</head>

<body>
  <h2>ILEARN Proficiency by School and School Corporation</h2>
  <div class="top">
    <form>
      <div class="radio-group">
        <span>Scale:</span>
        <input type="radio" id="option-1a" name="scale" value="Percentage"><label for="option-1a">Percentage</label>
        <input type="radio" id="option-1b" name="scale" value="Relative" checked><label for="option-1b">Relative</label>
      </div>
      <div class="radio-group">
        <!-- TODO: Make dropdown -->
        <span>Year:</span>
        <input type="radio" id="option-2a" name="year" value="2023" checked><label for="option-2a">2023</label>
        <input type="radio" id="option-2b" name="year" value="2022" checked><label for="option-2b">2022</label>
        <input type="radio" id="option-2c" name="year" value="2021" checked><label for="option-2c">2021</label>
        <input type="radio" id="option-2d" name="year" value="2019"><label for="option-2d">2019</label>
      </div>
      <!-- <div class="radio-group">
        <span>Grades:</span>
        <input type="radio" id="option-5a" name="grade" value="3-8" checked><label for="option-5a">3 - 8</label>
        <input type="radio" id="option-5b" name="grade" value="9-12"><label for="option-5b">9 - 12</label>
      </div> -->
      <div class="radio-group">
        <span>Subject:</span>
        <input type="radio" id="option-3a" name="subject" value="Math"><label for="option-3a">Math</label>
        <input type="radio" id="option-3b" name="subject" value="ELA"><label for="option-3b">ELA</label>
        <input type="radio" id="option-3c" name="subject" value="ELA & Math" checked><label for="option-3c">ELA &
          Math</label>
      </div>
    </form>
    <form>
      <div class="radio-group">

        <span>Grades:</span>
        <input type="radio" id="option-4a" name="category" value="School Total"><label for="option-4a">School
          Total</label>
        <input type="radio" id="option-4b" name="category" value="Grade 3"><label for="option-4b">3</label>
        <input type="radio" id="option-4c" name="category" value="Grade 4"><label for="option-4c">4</label>
        <input type="radio" id="option-4d" name="category" value="Grade 5"><label for="option-4d">5</label>
        <input type="radio" id="option-4e" name="category" value="Grade 6"><label for="option-4e">6</label>
        <input type="radio" id="option-4f" name="category" value="Grade 7"><label for="option-4f">7</label>
        <input type="radio" id="option-4g" name="category" value="Grade 8"><label for="option-4g">8</label>

        <span>Race/Ethnicity:</span>
        <input type="radio" id="option-4h" name="category" value="American Indian"><label for="option-4h">American
          Indian</label>
        <input type="radio" id="option-4i" name="category" value="Asian"><label for="option-4i">Asian</label>
        <input type="radio" id="option-4j" name="category" value="Black"><label for="option-4j">Black</label>
        <input type="radio" id="option-4k" name="category" value="Hispanic"><label for="option-4k">Hispanic</label>
        <input type="radio" id="option-4l" name="category" value="Multiracial"><label
          for="option-4l">Multiracial</label>
        <input type="radio" id="option-4m" name="category" value="Native Hawaiian or Other Pacific Islander"><label
          for="option-4m">Pacific Islander</label>
        <input type="radio" id="option-4n" name="category" value="White"><label for="option-4n">White</label>
        <span>Subgroup:</span>
        <input type="radio" id="option-4o" name="category" value="Special Education"><label for="option-4o">Special
          Education</label>
        <input type="radio" id="option-4p" name="category" value="General Education" checked><label
          for="option-4p">General
          Education</label>
        <input type="radio" id="option-4q" name="category" value="Paid Meals"><label for="option-4q">Paid Meals</label>
        <input type="radio" id="option-4r" name="category" value="Free or Reduced Price Meals"><label
          for="option-4r">Free
          or Reduced Price Meals</label>
        <input type="radio" id="option-4s" name="category" value="English Language Learners"><label
          for="option-4s">English
          Learners</label>
        <input type="radio" id="option-4t" name="category" value="Non-English Language Learners"><label
          for="option-4t">Non-English Learners</label>
      </div>
    </form>
  </div>
  <div class="map-container">
    <div class="map"></div>
    <div class="stats"></div>
  </div>

  <script>

    function per(d) {
      if (d === "***") {
        return "***"
      } else if (d === "" || isNaN(d)) {
        return "No Data"
      } else {
        return d3.format(",.2%")(d)
      }
    }

    function isNumeric(n) {
      return !isNaN(parseFloat(n)) && isFinite(n);
    }

    function zoomed(event) {
      const { transform } = event;
      svg.attr("transform", transform);
      svg.attr("stroke-width", 1 / transform.k);
      // svg.style("stroke-width", 1 / event.transform.k + "px");
      // svg.attr("transform", event.transform);
    }

    // called when a node (district) is clicked while active,
    // resets the map
    function reset() {
      active.classed("active", false);
      active = d3.select(null);

      svg.selectAll(".points")
        .transition()
        .duration(500)
        .remove();

      svg.transition()
        .duration(750)
        .call(zoom.transform, d3.zoomIdentity);
    }

    function stopped(event, d) {
      if (event.defaultPrevented) event.stopPropagation();
    }

    // takes as input an array of schools in a district- x, y and r values
    // determines if the circles overlap and if so, shifts them
    function shifty(s) { // shifty circles
      for (let q = 0; q < s.length - 1; q++) {
        for (let p = q + 1; p < s.length; p++) {
          if (Math.hypot(s[q].x - s[p].x, s[q].y - s[p].y) < 2 * s[q].r) {
            dx = s[p].x - s[q].x;
            dy = s[p].y - s[q].y;
            shift = (s[q].r * 2) - Math.hypot(s[q].x - s[p].x, s[q].y - s[p].y)
            if (dx > 0) { s[q].x = s[q].x - shift / 1.5 } else { s[q].x = s[q].x + shift / 1.5 } // if dx > 0 -> shift x0 left, else shift x0 right
            if (dy > 0) { s[q].y = s[q].y - shift / 1.5 } else { s[q].y = s[q].y + shift / 1.5 } // if dy > 0 -> shift y0 up, else shift y0 down
          }
        }
      }
      return s
    }

    var width = 700,
      height = 900,
      points,
      colors,
      legend,
      active = d3.select(null);

    // TODO: https://github.com/caged/d3-tip
    var tooltip = d3.select("body").append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);

    var svg = d3.select(".map")
      .append("svg")
      .attr("width", width)
      .attr("height", height)
      .append("g");

    var g = svg.append("g")
      .attr("class", "legendThreshold")
      .attr("transform", "translate(20,20)");
    g.append("text")
      .attr("fill", "steelblue")
      .attr("font-weight", "bold")
      .attr("class", "caption")
      .attr("x", 0)
      .attr("y", -6)
      .text("Proficiency");

    var zoom = d3.zoom()
      .scaleExtent([1, 8])
      .on("zoom", zoomed);

    // Enable Free Zoom
    //svg
    //  .call(zoom); 

    Promise.all([
      d3.csv("corporation_data_k8.csv"),
      d3.csv("academic_data_k8.csv"),
      d3.json("geocodes_corporations_2023.json"),
      d3.json("geocodes_schools_2023.json"),
    ]).then(function ([scdata, schdata, INdistricts, INschools]) {

      const districts = topojson.feature(INdistricts, INdistricts.objects.districts);
      const schools = topojson.feature(INschools, INschools.objects.publicschools);
      const mesh = topojson.mesh(INdistricts, INdistricts.objects.districts);
      const projection = d3.geoMercator().fitSize([width, height], mesh);

      var updateMap = function (scale, year, subject, category) {

        if (scale == 'Relative') {
          selectedDomain = [.05, .10, .15, .25, .35, .45, .55, .65];
          labels = ['0-5%', '6-10%', '11-15%', '16-25%', '26-35%', '36-45%', '46-55%', '55-65%', '> 66%'];
        }
        else {
          selectedDomain = [.20, .30, .40, .50, .60, .70, .80, .90];
          labels = ['0-20%', '21-30%', '31-40%', '41-50%', '51-60%', '61-70%', '71-80%', '81-90%', '> 91%'];
        }

        // if (grades == '3-8') { } else if (grades == '9-12') { };

        color = d3.scaleThreshold()
          .domain(selectedDomain)
          .range(["#e5eff9", "#cee1f2", "#b0d1e7", "#87bddc", "#5da4d0", "#3a89c1", "#1d6bb0", "#0e559d", "#08306b"]);

        legend = d3.legendColor()
          .labels(function (d) { return labels[d.i]; })
          .shapePadding(4)
          .scale(color);
        svg.select(".legendThreshold")
          .call(legend);

        // Calculate the top 10 schools for each Subject/Group (with n-size > 10)
        const proficiency_category = category + "|" + subject + " Proficiency %",
          n_size_category = category + "|" + subject + " Total Tested";

        // Filter data by selected year for both schools and corporations
        var year_data_school = schdata.filter(obj => {
          return obj.Year === year
        })
        console.log(year_data_school)
        var year_data_corp = scdata.filter(obj => {
          return obj.Year === year
        })

        const nSize = year_data_school.filter(d => +d[n_size_category] > 10);
        const proficiencyGroup = nSize.filter(d => isNumeric(d[proficiency_category]));

        // Sort array by proficiency of selected group/subject
        proficiencyGroup.sort(function (a, b) {
          if (+a[proficiency_category] === +b[proficiency_category]) { return 0 } else { return (+a[proficiency_category] < +b[proficiency_category]) ? -1 : 1 };
        });

        // get top ten school corporations for display
        topTen = proficiencyGroup.slice(proficiencyGroup.length - 10);

        // create top ten string from backwards from end to beginning
        let j = 0,
          txt = [];

        for (i = topTen.length - 1; i >= 0; i--) {
          txt[j] = j + 1 + ") " + topTen[i]['Corporation Name'] + ": " + per(topTen[i][proficiency_category]) + " (Total Tested: " + topTen[i][n_size_category] + ")"
          j++
        }

        d3.selectAll('.stats')
          .html(txt.join('<br/>'))

        // Draw Map
        var path = d3.geoPath().projection(projection);

        svg.append("g")
          .attr("class", "districts")
          .selectAll("path")
          .data(districts.features)
          .enter().append("path")
          .attr('data-fips', function (d) {
            return d.properties.NAME
          })
          .attr("d", path)
          .attr("fill", function (d, i) {

            // TODO: Not filling corp arcs on load. only on switch - problem is that
            // for some reason the color is applied, but not retained when zooming
            // but only right after load
            // TODO: check what happens to color on zoom

            const milla = year_data_corp.find(f => f['Corporation ID'] === d.properties.CORPID)

            // will be null if the school corporation does not exist
            // exist or was created (e.g., West Clark Community Schools 
            // dissolved in 2020 and Borden-Henryville was formed
            // TODO: Add West Clark Community Schools back for 2019
            // TODO: Will need to add a variable for Active/NonActive in
            // geocodes_corporations.js

            if (milla == null) { return "grey" }

            else if

              (milla[proficiency_category] === "" || milla[proficiency_category] === "***" || isNaN(milla[proficiency_category])) {

              return "grey"

            } else

              return color(milla[proficiency_category])

          })
          .attr("stroke", "white")
          .on("click", clicked)
          .on('mouseover', function (event, d) {
            let pos = d3.select(this).node().getBoundingClientRect();

            d3.select(this).classed("selected", true);

            const ber = year_data_corp.find(f => f['Corporation ID'] === d.properties.CORPID)

            if (ber != null) {
              tooltip.html(
                ber['Corporation Name'] + "<br>" + proficiency_category.slice(0, -2) + ": " + per(ber[proficiency_category]) + "<br>Total Tested: " + ber[n_size_category]
              )
                // tooltip is offset from mouse position
                .style('left', `${pos['x'] + 10}px`)
                .style('top', `${(window.pageYOffset + pos['y'] - 30)}px`)
                .style("opacity", 1);
            }
          })
          .on('mouseout', function (event, d) {

            d3.select(this).classed("selected", false);
            tooltip.style("opacity", 0)
          });

        // Zoom - Add points (schools)
        function clicked(event, d) {

          // TODO: On first click, there is no "active" node, so
          // if double-click the active node (the school corporation),
          // we reset map (zoom back out)
          if (active.node() === this) return reset();

          // clear active status from current node (if first click
          // there will be no active node)
          active.classed("active", false);

          // set current selection as active
          active = d3.select(this).classed("active", true);

          // console.log(d3.select(this).attr("fill"))

          var bounds = path.bounds(d),
            dx = bounds[1][0] - bounds[0][0],
            dy = bounds[1][1] - bounds[0][1],
            x = (bounds[0][0] + bounds[1][0]) / 2,
            y = (bounds[0][1] + bounds[1][1]) / 2,
            scale = Math.max(1, Math.min(10.5, 1 / Math.max(dx / width, dy / height))), // Size of zoomed district
            translate = [width / 2 - scale * x, height / 2 - scale * y];

          svg.transition()
            .duration(750)
            .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));

          var schoolsInPOLY = schools.features.filter(function (s) {

            if (d3.polygonContains(active.datum().geometry.coordinates[0], [s.geometry.coordinates[0], s.geometry.coordinates[1]])) {

              const max = 9; // Grade levels -> TODO: set according to checkbox tag (3-8 or 9-12)
              const min = 2;
              var low;

              if (s.properties.GSLO == 'PK' || s.properties.GSLO == 'KG') { low = 0 } else { low = parseInt(s.properties.GSLO) }

              if ((low < max && s.properties.GSHI > min) && (s.properties.SCHOOL_LEV != "CLOSED"
                && s.properties.SCHOOL_LEV != "Cooperative" && s.properties.SCHOOL_LEV != "Other"
                && s.properties.SCHOOL_LEV != "Special Education" && s.properties.SCHOOL_LEV != "Adult High School")) {

                return s.properties.LEAID
              }
            }
          })
          var schoolsInDist = { type: "FeatureCollection", "features": schoolsInPOLY };

          // Remove existing points each click (otherwise points keep propagating until reset event)
          svg.selectAll(".points")
            .transition()
            .duration(200)
            .remove();

          // TODO: hide school corp tooltips when zoomed.
          // svg.selectAll("path").on('mouseover', null);
          // tooltip.style("display", "none")
          console.log(tooltip)
          // calculate radius of individual points based on the number of
          // schools and the area per school of each district (this is 
          // somewhat arbitrary, but is needed to prevent weird outliers)
          district_size = dx * dy

          number_of_schools = schoolsInDist.features.length
          area_per_school = district_size / number_of_schools

          if (number_of_schools <= 5) {
            if (area_per_school <= 25) {
              rad = .75
            }
            else if (area_per_school > 25 & area_per_school <= 50) {
              rad = 1
            }
            else if (area_per_school > 50 & area_per_school <= 100) {
              rad = 1.5
            }
            else {
              rad = 2
            }
          }
          else if (number_of_schools > 5 & number_of_schools <= 12) {
            if (area_per_school <= 40) {
              rad = .75
            }
            else if (area_per_school > 40 & area_per_school <= 80) {
              rad = 1
            }
            else if (area_per_school > 80 & area_per_school <= 200) {
              rad = 1.5
            }
            else {
              rad = 2
            }
          }
          else if (number_of_schools > 12 & number_of_schools <= 16) {
            if (area_per_school <= 25) {
              rad = .75
            }
            else if (area_per_school > 25 & area_per_school <= 100) {
              rad = 1
            }
            else if (area_per_school > 100 & area_per_school <= 500) {
              rad = 1.5
            }
            else {
              rad = 2
            }
          }
          else if (number_of_schools > 16) {
            if (area_per_school <= 40) {
              rad = .75
            }
            else if (area_per_school > 40 & area_per_school <= 100) {
              rad = 1
            }
            else {
              rad = 1.5
            }
          }

          // spread out circles where there is overlap (shifty())
          // Is it faster to map to matrix first? Or run schoolsInDist.features through shifty()?
          // the latter hits projection() far more times (each time it loops)
          group = schoolsInDist.features.map(o => ({
            x: projection(o.geometry.coordinates)[0],
            y: projection(o.geometry.coordinates)[1],
            r: rad,
            school_id: o.properties.SCHOOL_ID
          }))

          // a second call to shifty pushes points out farther, but starts
          // to distort locations. if you call it more than more than two
          // times points get pushed outside of district boundaries
          // TODO: max push coordinates limited by district boundaries
          // shifty(group); 
          shifty(group);

          points = svg.append("g")
            .attr('class', 'points')
            .selectAll("circle")
            .data(group)
            .enter()
            .append("circle")
            .attr("cx", function (d) { return d.x })
            .attr("cy", function (d) { return d.y })
            .attr("r", function (d) { return d.r })
            .style("stroke", "white")
            .style("fill", function (d) {

              const nico = year_data_school.find(f => +f['School ID'] === +d.school_id)

              if (nico == null) { return "grey" }

              if (nico[proficiency_category] === "" || nico[proficiency_category] === "***" || isNaN(nico[proficiency_category]) || nico[proficiency_category] == null) {
                return "#ffffff"
              }
              else {
                return color(nico[proficiency_category])
              }
            })
            .style("opacity", 0)
            .on('mouseover', function (event, d) {

              let pos = d3.select(this).node().getBoundingClientRect();

              d3.select(this).classed("selected", true);

              const echo = year_data_school.find(f => +f['School ID'] === +d.school_id)

              if (echo != null) {
                tooltip.html(
                  echo['Corporation Name'] + "<br>" + echo['School Name'] + "<br>" + proficiency_category.slice(0, -2) + ": " + per(echo[proficiency_category]) + "<br>Total Tested: " + echo[n_size_category]
                )
                  .style('left', `${pos['x'] + 20}px`)
                  .style('top', `${(window.pageYOffset + pos['y'] - 70)}px`)
                  .style("opacity", 1);
              }
              console.log(tooltip)
            })
            .on('mouseout', function (d) {
              d3.select(this).classed("selected", false);
              tooltip.style("opacity", 0)
            });

          points.transition().duration(1000).style("opacity", .7);
        }
      }

      d3.selectAll("input").on("change", function () {
        var selectedScale = d3.select("input[name='scale']:checked").attr('value');
        var selectedYear = d3.select("input[name='year']:checked").attr('value');
        // var selectedGrades = d3.select("input[name='grades']:checked").attr('value');
        var selectedSubject = d3.select("input[name='subject']:checked").attr('value');
        var selectedCategory = d3.select("input[name='category']:checked").attr('value');

        updateMap(selectedScale, selectedYear, selectedSubject, selectedCategory)
      })

      updateMap('Relative', '2023', 'School Total', 'ELA')

      //   }
      // });
    }).catch(function (error) {
      console.error(error);
    })

  </script>
</body>

</html>