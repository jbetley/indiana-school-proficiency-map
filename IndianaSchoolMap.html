<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.7.0/d3.min.js"
    integrity="sha512-cd6CHE+XWDQ33ElJqsi0MdNte3S+bQY819f7p3NUHgwQQLXSKjE4cPZTeGNI+vaxZynk1wVU3hoHmow3m089wA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"
    integrity="sha512-wNH6xsp2n8CfB91nrBtfc4sfLwYPBMjSWVUwQOp60AYYXH6i8yCwuKFZ4rgK2i6pQek/b+bSyR7b01/922IBzQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"
    integrity="sha512-4UKI/XKm3xrvJ6pZS5oTRvIQGIzZFoXR71rRBb1y2N+PbwAsKa5tPl2J6WvbEvwN3TxQCm8hMzsl/pO+82iRlg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-polygon@3"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    /* TODO: Remove unused */

    body {
      font-size: 1em;
      line-height: 1.6;
      font-weight: 400;
      font-family: 'Inter', sans-serif;
      color: steelblue;
      background-color: #F2F2F2;
    }

    span {
      font-family: 'Inter', sans-serif;
      color: steelblue
    }

    div.tooltip {
      position: absolute;
      text-align: center;
      padding: 2px;
      font: 11px 'Inter', sans-serif;
      font-weight: bold;
      background: #e3e3e3;
      color: steelblue;
      border-radius: 8px;
      border: thin solid steelblue;
      pointer-events: none;
    }

    #popup-box {
      position: absolute;
      text-align: left;
      text-wrap: nowrap;
      line-height: 2;
      padding: 5px;
      font: 11px 'Inter', sans-serif;
      background: #e3e3e3;
      color: steelblue;
      border-radius: 8px;
      border: thin solid steelblue;
      pointer-events: none;
    }

    /* span.label {
      height: auto;
      font-size: .75em;
      font-family: 'Inter', sans-serif;
      color: #6783a9;
      text-align: center;
      margin: auto;
      font-weight: 500;
      padding-right: 5px;
      padding-left: 10px;
    } */

    .navigation {
      float: left;
    }

    .subnavigation {
      display: inline-block;
      vertical-align: middle;
    }

    .dropdowns {
      outline: none;
      display: inline-block;
      vertical-align: middle;
      padding-bottom: 2px;
      width: fit-content;
      white-space: nowrap;
      float: left;
    }

    select:focus {
      outline: none;
    }

    /*
    Cannot style option box/border unless you roll your own. See:
    https://www.w3schools.com/howto/tryit.asp?filename=tryhow_custom_select
    */

    .dropdown {
      display: inline-block;
      vertical-align: middle;
      background-color: white;
      border: thin steelblue;
      border-radius: 12px;
      font: inherit;
      font-size: 11px;
      padding: .2em 1em .2em 1em;
      color: #6783a9;
      border: 1px solid rgba(192, 193, 199, .5);
      border-radius: .5rem;
      text-transform: uppercase;

      /* reset */
      margin: 0;
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    .dropdown-label {
      padding-left: 7px;
      font-size: 12px;
      font-weight: 400;
      color: "steelblue";
    }

    .category-label {
      display: inline-block;
      vertical-align: middle;
      padding-left: 7px;
      padding-right: 7px;
      font-size: 12px;
      font-weight: 400;
      color: "steelblue";
    }

    .subcategory-label {
      display: inline-block;
      vertical-align: middle;
      padding-left: 7px;
      padding-right: 7px;
      font-size: 12px;
      font-weight: 400;
      color: "steelblue";
      float: left;
    }

    /* text.label {
      font-size: 1.2em;
      fill: #6783a9;
      background: #e3e3e3;
      display: inline-block;
      cursor: pointer;
      font-weight: 600;
      padding: 7px 7px;
      margin: 2px;
    } */

    .input-group .btn {
      position: relative;
      z-index: 2;
    }

    .input-group .btn:focus {
      z-index: 5;
    }

    .btn {
      line-height: 1;
      text-transform: uppercase;
      font-family: 'Inter', sans-serif;
      color: steelblue;
      background-color: #ffffff;
      font-size: 10px;
      font-weight: 500;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(192, 193, 199, .5);
      border-radius: .5rem;
      padding: 6px;
      width: 100%;
      text-align: center;
      box-sizing: border-box;
    }

    @media (prefers-reduced-motion: reduce) {
      .btn {
        transition: none;
      }
    }

    .btn:hover {
      line-height: 1;
      text-transform: uppercase;
      font-family: 'Inter', sans-serif;
      color: white;
      background-color: #c0c1c7;
      font-size: 11px;
      font-weight: 600;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(70, 130, 180, .5);
      border-radius: .5rem;
      padding: 6px;
      width: 100%;
      text-align: center;
      box-sizing: border-box;
    }

    .btn.active {
      line-height: 1;
      text-transform: uppercase;
      font-family: 'Inter', sans-serif;
      color: white;
      background-color: #c0c1c7;
      font-size: 11px;
      font-weight: 600;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(70, 130, 180, .5);
      border-radius: .5rem;
      padding: 6px;
      width: 100%;
      text-align: center;
      box-sizing: border-box;
    }

    .btn-outline-primary {
      --bs-btn-color: #6783a9;
      --bs-btn-border-color: #6783a9;
      --bs-btn-hover-color: #fff;
      --bs-btn-hover-bg: #6783a9;
      --bs-btn-hover-border-color: #6783a9;
      --bs-btn-focus-shadow-rgb: 13, 110, 253;
      --bs-btn-active-color: #fff;
      --bs-btn-active-bg: #6783a9;
      --bs-btn-active-border-color: #6783a9;
      --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
      --bs-btn-disabled-color: #6783a9;
      --bs-btn-disabled-bg: transparent;
      --bs-btn-disabled-border-color: #6783a9;
      --bs-gradient: none;
    }

    .btn-group {
      position: relative;
      display: inline-flex;
      vertical-align: middle;
      z-index: 99;
      margin: 0;
      padding: 0;
      margin-top: 3px;
      width: fit-content;
      white-space: nowrap;
      float: left;
    }

    input[type=radio] {
      position: absolute;
      visibility: hidden;
      display: none;
    }

    input[type=radio]:checked+label {
      color: #ffffff;
      background: #c0c1c7;
      border: 1px solid rgba(70, 130, 180, .5);
      border-radius: .5rem;
    }

    .legendThreshold {
      font-size: 10px;
      font-family: 'Inter', sans-serif;
    }

    .title-container {
      border-radius: 5px;
      background-color: #6783a9;
      color: #ffffff;
      margin: 5px;
      padding: 5px;
      position: relative;
      box-shadow: 2px 2px 2px lightgrey;
    }

    .title {
      padding-left: 15px;
    }

    /* Containers */

    .container {
      position: relative;
      width: 100%;
      max-width: 960px;
      margin: 0 auto;
      padding: 0 20px;
      box-sizing: border-box;
    }

    .column,
    .columns {
      width: 100%;
      float: left;
    }

    .column,
    .columns {
      margin-left: 0.5%;
    }

    .one.column,
    .one.columns {
      width: 8%;
    }

    .two.columns {
      width: 16.25%;
    }

    .three.columns {
      width: 22%;
    }

    .four.columns {
      width: 33%;
    }

    .five.columns {
      width: 39.3333333333%;
    }

    .six.columns {
      width: 49.75%;
    }

    .seven.columns {
      width: 56.6666666667%;
    }

    .eight.columns {
      width: 66.5%;
    }

    .nine.columns {
      width: 74.0%;
    }

    .ten.columns {
      width: 82.6666666667%;
    }

    .eleven.columns {
      width: 91.5%;
    }

    .twelve.columns {
      width: 100%;
      margin-left: 0;
    }

    .bare-container--flex--center {
      padding: 0 0 0 0;
      border-radius: 5px;
      background-color: #ffffff;
      margin: 10px;
      box-shadow: 2px 2px 2px lightgrey;
      display: flex;
    }

    .map-container {
      overflow: visible;
    }

    .map {
      float: left;
      width: 100%;
      height: 100%;
    }

    .row {
      margin: 0 0 0 0;
      padding: 0 0 0 0;
      justify-content: center;
      text-align: center;
    }

    /* .second-row {
      margin: 0 0 0 0;
      padding: 0 0 0 0;
      justify-content: center;
      text-align: center;
    } */

    .main-container {
      flex-direction: column;
    }

    /* .stats-container {
      display: inline-block;
      z-index: -1;
    } */

    .pretty-container--close {
      border-top-left-radius: 5px;
      border-top-right-radius: 5px;
      background-color: #ffffff;
      margin-top: 10px;
      padding-top: 15px;
      padding-right: 15px;
      padding-left: 15px;
      padding-bottom: 0px;
      width: 100%;
      position: relative;
      box-shadow: 2px 2px 2px lightgrey;
    }

    /* This controls the color of the school corporations when selected */
    .active {
      fill: #dbdbdb;
      opacity: .8;
    }

    #by-grade-content,
    #by-ethnicity-content,
    #by-subgroup-content {
      display: none;
    }
  </style>
</head>

<body>
  <div class="title-container">
    <div class="title">ILEARN Proficiency by School and School Corporation</div>
  </div>

  <form>
    <div class="row twelve columns">
      <div class="top-level-navigation">

        <div class="dropdowns">
          <label for="scale" class="dropdown-label">Scale:</label>
          <select id="scale" name="scale" class="dropdown">
            <option value="Relative">Relative</option>
            <option value="Percentage">Percentage</option>
          </select>
          <label for="year" class="dropdown-label">Year:</label>
          <select id="year" name="year" class="dropdown">
            <option value="2023">2023</option>
            <option value="2022">2022</option>
            <option value="2021">2021</option>
            <option value="2019">2019</option>
          </select>
          <label for="subject" class="dropdown-label">Subject:</label>
          <select id="subject" name="subject" class="dropdown">
            <option value="ELA">ELA</option>
            <option value="Math">Math</option>
            <option value="ELA & Math">ELA & Math</option>
          </select>
        </div>

        <div class="navigation">
          <label for="navigation" class="category-label">Category:</label>
          <input type="radio" id="option-1n" name="navigation" value="by-grade" checked><label for="option-1n"
            class="btn btn-outline-primary">By Grade</label>
          <input type="radio" id="option-2n" name="navigation" value="by-ethnicity"><label for="option-2n"
            class="btn btn-outline-primary">By Ethnicity</label>
          <input type="radio" id="option-3n" name="navigation" value="by-subgroup"><label for="option-3n"
            class="btn btn-outline-primary">By Subgroup</label>
        </div>

      </div>
    </div>

    <div class="subnavigation">

      <div id="by-grade-content">
        <div class="btn-group">
          <label for="subnavigation" class="subcategory-label">Sub-Category:</label>
          <input type="radio" id="option-1a" name="category-by-grade" value="School Total" checked><label
            for="option-1a" class="btn btn-outline-primary">School Total</label>
          <input type="radio" id="option-1b" name="category-by-grade" value="Grade 3"><label for="option-1b"
            class="btn btn-outline-primary">3</label>
          <input type="radio" id="option-1c" name="category-by-grade" value="Grade 4"><label for="option-1c"
            class="btn btn-outline-primary">4</label>
          <input type="radio" id="option-1d" name="category-by-grade" value="Grade 5"><label for="option-1d"
            class="btn btn-outline-primary">5</label>
          <input type="radio" id="option-1e" name="category-by-grade" value="Grade 6"><label for="option-1e"
            class="btn btn-outline-primary">6</label>
          <input type="radio" id="option-1f" name="category-by-grade" value="Grade 7"><label for="option-1f"
            class="btn btn-outline-primary">7</label>
          <input type="radio" id="option-1g" name="category-by-grade" value="Grade 8"><label for="option-1g"
            class="btn btn-outline-primary">8</label>
        </div>
      </div>

      <div id="by-ethnicity-content">
        <div class="btn-group">
          <label for="subnavigation" class="subcategory-label">Sub-Category:</label>
          <input type="radio" id="option-2a" name="category-by-ethnicity" value="American Indian" checked><label
            for="option-2a" class="btn btn-outline-primary">American Indian</label>
          <input type="radio" id="option-2b" name="category-by-ethnicity" value="Asian"><label for="option-2b"
            class="btn btn-outline-primary">Asian</label>
          <input type="radio" id="option-2c" name="category-by-ethnicity" value="Black"><label for="option-2c"
            class="btn btn-outline-primary">Black</label>
          <input type="radio" id="option-2d" name="category-by-ethnicity" value="Hispanic"><label for="option-2d"
            class="btn btn-outline-primary">Hispanic</label>
          <input type="radio" id="option-2e" name="category-by-ethnicity" value="Multiracial"><label for="option-2e"
            class="btn btn-outline-primary">Multiracial</label>
          <input type="radio" id="option-2f" name="category-by-ethnicity"
            value="Native Hawaiian or Other Pacific Islander"><label for="option-2f"
            class="btn btn-outline-primary">Pacific Islander</label>
          <input type="radio" id="option-2g" name="category-by-ethnicity" value="White"><label for="option-2g"
            class="btn btn-outline-primary">White</label>
        </div>
      </div>

      <div id="by-subgroup-content">
        <div class="btn-group">
          <label for="subnavigation" class="subcategory-label">Sub-Category:</label>
          <input type="radio" id="option-3a" name="category-by-subgroup" value="English Language Learners"
            checked><label for="option-3a" class="btn btn-outline-primary">English
            Learners</label>
          <input type="radio" id="option-3b" name="category-by-subgroup" value="Non-English Language Learners"><label
            for="option-3b" class="btn btn-outline-primary">Non-English Learners</label>
          <input type="radio" id="option-3c" name="category-by-subgroup" value="General Education"><label
            for="option-3c" class="btn btn-outline-primary">General
            Education</label>
          <input type="radio" id="option-3d" name="category-by-subgroup" value="Special Education"><label
            for="option-3d" class="btn btn-outline-primary">Special
            Education</label>
          <input type="radio" id="option-3e" name="category-by-subgroup" value="Free or Reduced Price Meals"><label
            for="option-3e" class="btn btn-outline-primary">Free
            or Reduced Price Meals</label>
          <input type="radio" id="option-3f" name="category-by-subgroup" value="Paid Meals"><label for="option-3f"
            class="btn btn-outline-primary">Paid Meals</label>
        </div>
      </div>
    </div>
    </div>

  </form>

  <div class="main-container">
    <div class="bare-container--flex--center twelve columns">
      <div class="pretty-container--close--top twelve columns">
        <div class="map-container">
          <div class="map"></div>
        </div>
      </div>
    </div>
  </div>

  <script>

    // hide/show subnavigation radio buttons based on navigation selection
    var subNavigation = document.querySelector(".navigation");

    // set by-grade-content to display initially or on reload (default)
    document.getElementById("by-grade-content").style.display = "block";

    subNavigation.addEventListener("click", function (e) {

      //  On click, get subnav content divs and set default display to none
      var divs = document.querySelectorAll('div.subnavigation > div');

      for (let div of divs) {
        div.style.display = "none";
      }

      // display target id div
      if (e.target.value) {
        target_div = e.target.value + "-content"
        document.getElementById(target_div).style.display = "block";
      }
    });

    // dashboard helper functions
    function calc_percent(d) {
      if (d === "***") {
        return "***"
      } else if (d === "" || isNaN(d)) {
        return "No Data"
      } else {
        return d3.format(",.2%")(d)
      }
    }

    function isNumeric(n) {
      return !isNaN(parseFloat(n)) && isFinite(n);
    }

    function zoomed(event) {
      const { transform } = event;
      svg.attr("transform", transform);
      svg.attr("stroke-width", 1 / transform.k);
    }

    // map is reset when a node (district) is clicked while active
    function reset() {
      active.classed("active", false);
      active = d3.select(null);

      svg.selectAll(".points")
        .transition()
        .duration(500)
        .remove();

      svg.transition()
        .duration(750)
        .call(zoom.transform, d3.zoomIdentity);
    }

    function stopped(event, d) {
      if (event.defaultPrevented) event.stopPropagation();
    }

    // takes as input an array of points x, y and r values, determines
    // if the circles overlap and if so, shifts their coordinates
    // away from each other. can give inconsistent results if there
    // are multiple points right next to each other
    // if dx > 0 -> shift x0 left, else shift x0 right
    // if dy > 0 -> shift y0 up, else shift y0 down
    function shifty(s) {
      for (let q = 0; q < s.length - 1; q++) {
        for (let p = q + 1; p < s.length; p++) {
          if (Math.hypot(s[q].x - s[p].x, s[q].y - s[p].y) < 2 * s[q].r) {
            dx = s[p].x - s[q].x;
            dy = s[p].y - s[q].y;
            shift = (s[q].r * 2) - Math.hypot(s[q].x - s[p].x, s[q].y - s[p].y)
            if (dx > 0) { s[q].x = s[q].x - shift / 1.5 } else { s[q].x = s[q].x + shift / 1.5 }
            if (dy > 0) { s[q].y = s[q].y - shift / 1.5 } else { s[q].y = s[q].y + shift / 1.5 }
          }
        }
      }
      return s
    }

    function calculateGap(data, subject, category) {
      if (category == "Black" || category == "Multiracial" ||
        category == "Hispanic" || category == "Asian") {
        first_category = "White"
        second_category = category
      }

      else if (category == "Paid Meals") {
        first_category = category
        second_category = "Free or Reduced Price Meals"
      }

      else if (category == "Free or Reduced Price Meals") {
        first_category = "Paid Meals"
        second_category = category
      }

      else if (category == "Non-English Language Learners") {
        first_category = "English Language Learners"
        second_category = category
      }

      else if (category == "English Language Learners") {
        first_category = category
        second_category = "Non-English Language Learners"
      }

      else if (category == "Special Education") {
        first_category = "General Education"
        second_category = category
      }

      else if (category == "General Education") {
        first_category = category
        second_category = "Special Education"
      }
      else { return }

      first_tested = first_category + "|" + subject + " Total Tested";
      second_tested = second_category + "|" + subject + " Total Tested";

      // minimum n-size
      const n = 20
      const gapSet = data.filter(d => {
        if (+d[first_tested] < n) return false;
        if (+d[second_tested] < n) return false;
        return d;

      });

      gapList = []

      first_proficiency = first_category + "|" + subject + " Proficiency %";
      second_proficiency = second_category + "|" + subject + " Proficiency %";

      const gapDifference = gapSet.map(item => {
        first_item = parseFloat(item[first_proficiency]);
        second_item = parseFloat(item[second_proficiency]);

        if (second_item > first_item) {
          first_value = second_item
          second_value = first_item
          higher_category = second_category
          lower_category = first_category
        }
        else {
          first_value = first_item
          second_value = second_item
          higher_category = first_category
          lower_category = second_category
        }

        gapObj = new Object();
        if ("School Name" in item) {
          gapObj['School Name'] = item['School Name']
        }
        gapObj['Corporation Name'] = item['Corporation Name']

        gapObj["First Name"] = higher_category
        gapObj["First"] = first_value
        gapObj["Second Name"] = lower_category
        gapObj["Second"] = second_value
        gapObj["Difference"] = Math.abs(first_value - second_value);
        gapList.push(gapObj)
      });

      gapList.sort(function (a, b) {
        if (+a["Difference"] === +b["Difference"]) { return 0 } else { return (+a["Difference"] < +b["Difference"]) ? -1 : 1 };
      });

      badGaps = gapList.slice(gapList.length - 10);

      return badGaps
    }
    var width = 800,
      height = 800,
      points,
      colors,
      legend,
      active = d3.select(null);

    var tooltip = d3.select("body").append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);

    var svg = d3.select(".map")
      .append("svg")
      .attr("width", width)
      .attr("height", height)
      .append("g");

    var leg = svg.append("g")
      .attr("class", "legendThreshold")
      .attr("transform", "translate(20,80)");
    leg.append("text")
      .attr("fill", "steelblue")
      .attr("font-weight", "bold")
      .attr("class", "caption")
      .attr("x", 0)
      .attr("y", -6)
      .text("Percentage Proficient");

    var zoom = d3.zoom()
      .scaleExtent([1, 8])
      .on("zoom", zoomed);

    // Enable Free Zoom
    //svg
    //  .call(zoom); 

    Promise.all([
      d3.csv("corporation_data_k8.csv"),
      d3.csv("academic_data_k8.csv"),
      d3.json("geocodes_corporations_2023.json"),
      d3.json("geocodes_schools_2023.json"),
    ]).then(function ([scdata, schdata, INdistricts, INschools]) {

      const districts = topojson.feature(INdistricts, INdistricts.objects.districts);
      const schools = topojson.feature(INschools, INschools.objects.publicschools);
      const mesh = topojson.mesh(INdistricts, INdistricts.objects.districts);
      const projection = d3.geoMercator().fitSize([width, height], mesh);

      var updateMap = function (scale, year, subject, category) {

        // changing category while zoomed changes district color
        // and hides school points, which isn't ideal (would prefer
        // for points to shift color as appropriate), until this is
        // fixed, we just reset any potential zoom every time 
        // category is changed

        // TODO: make it so that points change color when category
        // changes while zoomed

        reset()

        // clear category title each update, otherwise will 
        // keep adding on top of one another
        d3.selectAll('.map-title-text')
          .style("opacity", 0)

        if (scale == 'Relative') {
          selectedDomain = [.05, .10, .15, .25, .35, .45, .55, .65];
          labels = ['0-5%', '6-10%', '11-15%', '16-25%', '26-35%', '36-45%', '46-55%', '55-65%', '> 66%'];
        }
        else {
          selectedDomain = [.20, .30, .40, .50, .60, .70, .80, .90];
          labels = ['0-20%', '21-30%', '31-40%', '41-50%', '51-60%', '61-70%', '71-80%', '81-90%', '> 91%'];
        }

        color = d3.scaleThreshold()
          .domain(selectedDomain)
          .range(["#e5eff9", "#cee1f2", "#b0d1e7", "#87bddc", "#5da4d0", "#3a89c1", "#1d6bb0", "#0e559d", "#08306b"]);

        legend = d3.legendColor()
          .labels(function (d) { return labels[d.i]; })
          .shapePadding(4)
          .scale(color);
        svg.select(".legendThreshold")
          .call(legend);

        // Filter data by selected year
        var year_data_school = schdata.filter(obj => {
          return obj.Year === year
        })

        var year_data_corp = scdata.filter(obj => {
          return obj.Year === year
        })

        // categories for Top 10 tooltips
        const proficiency_category = category + "|" + subject + " Proficiency %";
        const n_size_category = category + "|" + subject + " Total Tested";
        const total_proficient = category + "|" + subject + " Total Proficient";

        // calculate state average for each category
        // NOTE: This is much harder than it sounds for certain categories due
        // to the large number of redactions due to insufficient n-size - for
        // example: we are unable to generate an average at all for American
        // Indian using school data because no school has a sufficiently large
        // American Indian population to generate a value. We can generate an
        // average using aggregated corporation data, but it is also skewed
        // because tested students show up in the denominator but not in
        // the numerator (e.g., the numerator is "***") - so perhaps best case
        // scenario is to disregard all rows with a total proficiency of "***".
        // the final number still will not be completely accurate, but it is 
        // probably the best we can do.

        // only keep objects where the total # of tested students for a category
        // is not either "***" or ""
        const data_adjusted = year_data_corp.filter(function (el) {
          return el[total_proficient] != "***" && el[total_proficient] != ""
        });

        const sum_tested = d3.sum(data_adjusted, d => d[n_size_category]);
        const sum_proficient = d3.sum(data_adjusted, d => d[total_proficient]);
        const state_average = sum_proficient / sum_tested

        school_gap = calculateGap(year_data_school, subject, category)

        corp_gap = calculateGap(year_data_corp, subject, category)

        // add map title
        var maptitle = svg.append("g")
          .attr("class", "map-title")
          .attr("transform", "translate(180,5)");

        maptitle.append("rect")
          .attr('width', 350)
          .attr('height', 20)
          .style("fill", "white")
          .style("pointer-events", "visible")

        maptitle.append("text")
          .attr("fill", "steelblue")
          .attr("font-weight", "bold")
          .attr("font-size", "14px")
          .attr("class", "map-title-text")
          .style("pointer-events", "visible")
          .attr("dx", function (d) { return 6 })
          .attr("dy", function (d) { return 13 })
          .style("opacity", 1)
          .text(proficiency_category + " (State Average: " + calc_percent(state_average) + ")");

        // add tooltips for Top 10 Schools and School Corporations
        // for selected category

        // top10 schools for selected category
        var schooltop = svg.append("g")
          .attr("class", "top-schools")
          .attr("transform", "translate(565,40)");

        schooltop.append("rect")
          .attr('width', 220)
          .attr('height', 20)
          .attr("rx", function (d) { return 5 })
          .attr("ry", function (d) { return 5 })
          .style("stroke", "steelblue")
          .style("fill", "steelblue")
          .style("pointer-events", "visible")

        schooltop.append("text")
          .attr("fill", "white")
          .attr("font-weight", "bold")
          .attr("font-size", "10px")
          .attr("class", "infobar-text")
          .style("pointer-events", "visible")
          .attr("text-anchor", "middle")
          .attr("dominant-baseline", "middle")
          .attr("dx", 110)
          .attr("dy", 11)
          .text("Highest Proficiency: Schools");

        schooltop.on("mouseover", function (event, d) {
          let pos = d3.select(this).node().getBoundingClientRect();

          const school_nSize = year_data_school.filter(d => +d[n_size_category] > 10);
          const schoolProficiency = school_nSize.filter(d => isNumeric(d[proficiency_category]));

          schoolProficiency.sort(function (a, b) {
            if (+a[proficiency_category] === +b[proficiency_category]) { return 0 } else { return (+a[proficiency_category] < +b[proficiency_category]) ? -1 : 1 };
          });

          schoolTopTen = schoolProficiency.slice(schoolProficiency.length - 10);

          let j = 0,
            school_txt = [];

          for (k = schoolTopTen.length - 1; k >= 0; k--) {
            school_txt[j] = j + 1 + ") <b>" + schoolTopTen[k]['School Name'] + "</b>: <b>" +
              calc_percent(schoolTopTen[k][proficiency_category]) + "</b> (n-size: " +
              schoolTopTen[k][n_size_category] + ")<br/> (" + schoolTopTen[k]['Corporation Name'] + ")."
            j++

            tooltip.html(school_txt.join('<br/><br/>'))
              .style('left', `${pos['x'] - 1}px`)
              .attr("id", "popup-box")
              .style('top', `${(window.pageYOffset + pos['y'] + 39)}px`)
              .style("opacity", 1);
          }
        })
          .on('mouseout', function (d) {
            d3.select(this).classed("selected", false);
            d3.selectAll('.tooltip')
              .style("opacity", 0)
          });

        // top10 school corporations
        var corptop = svg.append("g")
          .attr("class", "top-corps")
          .attr("transform", "translate(565,80)");

        corptop.append("rect")
          .attr('width', 220)
          .attr('height', 20)
          .attr("rx", function (d) { return 5 })
          .attr("ry", function (d) { return 5 })
          .style("stroke", "steelblue")
          .style("fill", "steelblue")
          .style("pointer-events", "visible")

        corptop.append("text")
          .attr("fill", "white")
          .attr("font-weight", "bold")
          .attr("font-size", "10px")
          .attr("class", "infobar-text")
          .style("pointer-events", "visible")
          .attr("text-anchor", "middle")
          .attr("dominant-baseline", "middle")
          .attr("dx", 110)
          .attr("dy", 11)
          .text("Highest Proficiency: Corporations");

        corptop.on("mouseover", function (event, d) {
          let pos = d3.select(this).node().getBoundingClientRect();

          const corpProficiency = year_data_corp.filter(d => isNumeric(d[proficiency_category]));

          corpProficiency.sort(function (a, b) {
            if (+a[proficiency_category] === +b[proficiency_category]) { return 0 } else { return (+a[proficiency_category] < +b[proficiency_category]) ? -1 : 1 };
          });

          corpTopTen = corpProficiency.slice(corpProficiency.length - 10);

          let j = 0,
            corp_txt = [];

          for (k = corpTopTen.length - 1; k >= 0; k--) {
            corp_txt[j] = j + 1 + ") <b>" + corpTopTen[k]['Corporation Name'] + "</b>: <b>" +
              calc_percent(corpTopTen[k][proficiency_category]) + "</b>."
            j++

            tooltip.html(corp_txt.join('<br/><br/>'))
              .style('left', `${pos['x'] - 1}px`)
              .attr("id", "popup-box")
              .style('top', `${(window.pageYOffset + pos['y'] + 39)}px`)
              .style("opacity", 1);
          }
        })
          .on('mouseout', function (d) {
            d3.select(this).classed("selected", false);
            d3.selectAll('.tooltip')
              .style("opacity", 0)
          });

        // Achievement Gaps - School
        var schoolgaps = svg.append("g")
          .attr("class", "gaps-school")
          .attr("transform", "translate(565,120)");

        schoolgaps.append("rect")
          .attr('width', 220)
          .attr('height', 20)
          .attr("rx", function (d) { return 5 })
          .attr("ry", function (d) { return 5 })
          .style("stroke", "steelblue")
          .style("fill", "steelblue")
          .style("pointer-events", "visible")

        schoolgaps.append("text")
          .attr("fill", "white")
          .attr("font-weight", "bold")
          .attr("font-size", "10px")
          .attr("class", "infobar-text")
          .style("pointer-events", "visible")
          .attr("text-anchor", "middle")
          .attr("dominant-baseline", "middle")
          .attr("dx", 110)
          .attr("dy", 11)
          .text("Largest Achievement Gaps: Schools");

        schoolgaps.on("mouseover", function (event, d) {
          let pos = d3.select(this).node().getBoundingClientRect();

          school_gap = calculateGap(year_data_school, subject, category)

          if (typeof school_gap == 'undefined') { return }

          let j = 0,
            school_gap_txt = [];

          for (k = school_gap.length - 1; k >= 0; k--) {

            // school achievement gap popup window
            school_gap_txt[j] = j + 1 + ") <b>" + school_gap[k]["School Name"] + "</b>: <b>" +
              calc_percent(school_gap[k]["Difference"]) + "</b><br/>" + school_gap[k]["Corporation Name"] +
              "<br/>(" + school_gap[k]["First Name"] + ": " + calc_percent(school_gap[k]["First"]) +
              " - " + school_gap[k]["Second Name"] + ": " + calc_percent(school_gap[k]["Second"]) + ")."

            j++

            tooltip.html(school_gap_txt.join('<br/><br/>'))
              .style('left', `${pos['x'] - 1}px`)
              .attr("id", "popup-box")
              .style('top', `${(window.pageYOffset + pos['y'] + 39)}px`)
              .style("opacity", 1)
          }
        })
          .on('mouseout', function (d) {
            d3.select(this).classed("selected", false);
            d3.selectAll('.tooltip')
              .style("opacity", 0)
          });

        // Achievement Gaps - Corporations
        var corpgaps = svg.append("g")
          .attr("class", "gaps-corp")
          .attr("transform", "translate(565,160)");

        corpgaps.append("rect")
          .attr('width', 220)
          .attr('height', 20)
          .attr("rx", function (d) { return 5 })
          .attr("ry", function (d) { return 5 })
          .style("stroke", "steelblue")
          .style("fill", "steelblue")
          .style("pointer-events", "visible")

        corpgaps.append("text")
          .attr("fill", "white")
          .attr("font-weight", "bold")
          .attr("font-size", "10px")
          .attr("class", "infobar-text")
          .style("pointer-events", "visible")
          .attr("text-anchor", "middle")
          .attr("dominant-baseline", "middle")
          .attr("dx", 110)
          .attr("dy", 11)
          .text("Largest Achievement Gaps: Corporations");

        corpgaps.on("mouseover", function (event, d) {
          let pos = d3.select(this).node().getBoundingClientRect();

          corp_gap = calculateGap(year_data_corp, subject, category)

          if (typeof corp_gap == 'undefined') { return }

          let j = 0,
            corp_gap_txt = [];

          for (k = corp_gap.length - 1; k >= 0; k--) {

            // corporation achievement gap popup window
            corp_gap_txt[j] = j + 1 + ") <b>" + corp_gap[k]["Corporation Name"] + "</b>: <b>" +
              calc_percent(corp_gap[k]["Difference"]) + "</b><br/> (" + corp_gap[k]["First Name"] +
              ": " + calc_percent(corp_gap[k]["First"]) + " - " + corp_gap[k]["Second Name"] + ": " +
              calc_percent(corp_gap[k]["Second"]) + ")."

            j++

            tooltip.html(corp_gap_txt.join('<br/><br/>'))
              .style('left', `${pos['x'] - 1}px`)
              .attr("id", "popup-box")
              .style('top', `${(window.pageYOffset + pos['y'] + 39)}px`)
              .style("opacity", 1);
          }
        })
          .on('mouseout', function (d) {
            d3.select(this).classed("selected", false);
            d3.selectAll('.tooltip')
              .style("opacity", 0)
          });

        // Draw Map
        var path = d3.geoPath().projection(projection);

        // we are shifting map, 100px left and 50px down
        // all other objects must be shifted the same amount
        // in order to line up correctly (especially during
        // zoom, where we need to multiply the shift by
        // the scale factor)
        svg.append("g")
          .attr("class", "districts")
          .selectAll("path")
          .data(districts.features)
          .enter().append("path")
          .attr('data-fips', function (d) {
            return d.properties.NAME
          })
          .attr("d", path)
          .attr("transform", "translate(-100,30)")
          .attr("fill", function (d, i) {

            // TODO: On the very first load of the map, the district background color is
            // not kept when zooming. After reloading the updateMap() function, district
            // background color starts behaving normally (e.g., background color has the
            // selected color with low opacity overlaid on it).

            const milla = year_data_corp.find(f => f['Corporation ID'] === d.properties.CORPID)

            // will be null if the school corporation does not exist
            // exist or was created (e.g., West Clark Community Schools 
            // dissolved in 2020 and Borden-Henryville was formed
            if (milla == null) { return "grey" }

            if
              (milla[proficiency_category] === "" || milla[proficiency_category] === "***" || isNaN(milla[proficiency_category])) {
              return "grey"
            } else
              return color(milla[proficiency_category])

          })
          .attr("stroke", "white")
          .on("click", clicked)
          .on('mouseover', function (event, d) {
            let pos = d3.select(this).node().getBoundingClientRect();

            d3.select(this).classed("selected", true);

            const ber = year_data_corp.find(f => f['Corporation ID'] === d.properties.CORPID)

            // NOTE: svg._groups[0][0].__zoom.k gives us the "k" transform value, aka the
            // current zoom amount. so tooltips are only shown if k == 1 (it is not zoomed in)
            if ((ber != null) & (svg._groups[0][0].__zoom.k == 1)) {
              tooltip.html(
                ber['Corporation Name'] + "<br>" + proficiency_category.slice(0, -2) + ": " + calc_percent(ber[proficiency_category]) + "<br>Total Tested: " + ber[n_size_category]
              )
                // tooltip is offset from mouse position
                .style('left', `${pos['x'] + 10}px`)
                .style('top', `${(window.pageYOffset + pos['y'] - 30)}px`)
                .style("opacity", 1);
            }
          })
          .on('mouseout', function (event, d) {
            d3.select(this).classed("selected", false);
            tooltip.style("opacity", 0)
          });

        // Zoom - Add points (schools)
        function clicked(event, d) {

          // if active node (district) is clicked, reset map
          if (active.node() === this) return reset();

          // clear active status from whichever node is
          // currently active
          active.classed("active", false);

          // set current selection as active
          active = d3.select(this).classed("active", true);

          // get the LEAID of the active (selected) node
          activeDistrictLEAID = active._groups[0][0].__data__.properties.GEOID

          var bounds = path.bounds(d),
            dx = bounds[1][0] - bounds[0][0],
            dy = bounds[1][1] - bounds[0][1],
            x = (bounds[0][0] + bounds[1][0]) / 2,
            y = (bounds[0][1] + bounds[1][1]) / 2,
            scale = Math.max(1, Math.min(10.5, 1 / Math.max(dx / width, dy / height))), // Size of zoomed district
            translate = [width / 2 - scale * x, height / 2 - scale * y];

          // map is shifted (-100,30). in order to account for this, we need
          // to translate the zoom, but first we need to multiple it by the
          // scale. Adding fifty seems to center the districts a bit
          // better. if scale changes, need to to re-examine the appropriate
          // x and y shift values
          let xshift = (scale * 100) + 50
          let yshift = (scale * 30) + 50
          svg.transition()
            .duration(750)
            .call(zoom.transform, d3.zoomIdentity.translate(translate[0] + xshift, translate[1] - yshift).scale(scale));

          var schoolsInPOLY = schools.features.filter(function (s) {

            if (d3.polygonContains(active.datum().geometry.coordinates[0], [s.geometry.coordinates[0], s.geometry.coordinates[1]])) {

              // TODO: add HS categories
              const max = 9;
              const min = 2;
              var low;

              // filter points by characteristic (hides schools we do not want 
              // to display. we also check to make sure that all points are
              // contained within the same LEIAD as the active district - this
              // makes sure we do not display schools that are located in another
              // district that the geographically located wholly inside the
              // selected district
              if (s.properties.GSLO == 'PK' || s.properties.GSLO == 'KG') { low = 0 } else { low = parseInt(s.properties.GSLO) }

              if ((
                low < max && s.properties.GSHI > min) && (s.properties.LEAID == activeDistrictLEAID)
                && (s.properties.SCHOOL_LEV != "CLOSED" && s.properties.SCHOOL_LEV != "Cooperative"
                  && s.properties.SCHOOL_LEV != "Other" && s.properties.SCHOOL_LEV != "Special Education"
                  && s.properties.SCHOOL_LEV != "Adult High School"
                )) {

                return s.properties.LEAID
              }
            }
          })

          var schoolsInDist = { type: "FeatureCollection", "features": schoolsInPOLY };

          // Remove existing points each click (otherwise points
          // keep propagating until reset event)
          svg.selectAll(".points")
            .transition()
            .duration(200)
            .remove();

          // calculate radius of individual points based on the number of
          // schools and the area per school of each district (this is 
          // somewhat arbitrary, but is needed to prevent weird outliers)
          district_size = dx * dy

          number_of_schools = schoolsInDist.features.length
          area_per_school = district_size / number_of_schools

          if (number_of_schools <= 5) {
            if (area_per_school <= 25) {
              rad = .75
            }
            else if (area_per_school > 25 & area_per_school <= 50) {
              rad = 1
            }
            else if (area_per_school > 50 & area_per_school <= 100) {
              rad = 1.5
            }
            else {
              rad = 2
            }
          }
          else if (number_of_schools > 5 & number_of_schools <= 12) {
            if (area_per_school <= 40) {
              rad = .75
            }
            else if (area_per_school > 40 & area_per_school <= 80) {
              rad = 1
            }
            else if (area_per_school > 80 & area_per_school <= 200) {
              rad = 1.5
            }
            else {
              rad = 2
            }
          }
          else if (number_of_schools > 12 & number_of_schools <= 16) {
            if (area_per_school <= 25) {
              rad = .75
            }
            else if (area_per_school > 25 & area_per_school <= 100) {
              rad = 1
            }
            else if (area_per_school > 100 & area_per_school <= 500) {
              rad = 1.5
            }
            else {
              rad = 2
            }
          }
          else if (number_of_schools > 16) {
            if (area_per_school <= 40) {
              rad = .75
            }
            else if (area_per_school > 40 & area_per_school <= 100) {
              rad = 1
            }
            else {
              rad = 1.5
            }
          }

          // get points located within the geographic coordinates
          group = schoolsInDist.features.map(o => ({
            x: projection(o.geometry.coordinates)[0],
            y: projection(o.geometry.coordinates)[1],
            r: rad,
            school_id: o.properties.SCHOOL_ID
          }))

          // points can be on top of each other, so we use the shifty()
          // function to spread out circles whenever points overlap
          // NOTE: a second call to shifty pushes points out farther, but
          // starts to distort locations. more than 2 calls and points 
          // get pushed outside of district boundaries
          shifty(group);

          points = svg.append("g")
            .attr('class', 'points')
            .selectAll("circle")
            .data(group)
            .enter()
            .append("circle")
            .attr("cx", function (d) { return d.x })
            .attr("cy", function (d) { return d.y })
            .attr("r", function (d) { return d.r })
            .attr("transform", "translate(-100,30)") // accounting for map shift
            .style("stroke", "white")
            .style("fill", function (d) {

              const nico = year_data_school.find(f => +f['School ID'] === +d.school_id)

              if (nico == null) { return "grey" }

              if (nico[proficiency_category] === "" || nico[proficiency_category] === "***" || isNaN(nico[proficiency_category]) || nico[proficiency_category] == null) {
                return "#ffffff"
              }
              else {
                return color(nico[proficiency_category])
              }
            })
            .style("opacity", 0)
            .on('mouseover', function (event, d) {

              let pos = d3.select(this).node().getBoundingClientRect();

              d3.select(this).classed("selected", true);

              const echo = year_data_school.find(f => +f['School ID'] === +d.school_id)

              if (echo != null) {

                tooltip.html(
                  echo['School Name'] + "<br>" + proficiency_category.slice(0, -2) + ": " + calc_percent(echo[proficiency_category]) + "<br>Total Tested: " + echo[n_size_category]
                )
                  .style('left', `${pos['x'] + 20}px`)
                  .style('top', `${(window.pageYOffset + pos['y'] - 70)}px`)
                  .style("opacity", 1);
              }
            })
            .on('mouseout', function (d) {
              d3.select(this).classed("selected", false);
              tooltip.style("opacity", 0)
            });

          points.transition().duration(1000).style("opacity", .7);
        }
      }

      // update map on change on any select or input element
      d3.selectAll("input, select").on("change", function () {

        var selectedScale = d3.select("#scale")._groups[0][0].value
        var selectedYear = d3.select("#year")._groups[0][0].value
        var selectedSubject = d3.select("#subject")._groups[0][0].value
        var selectedNav = d3.select("input[name='navigation']:checked").attr('value');

        subNavigation = "category-" + selectedNav
        var selectedCategory = d3.select("input[name=" + subNavigation + "]:checked").attr('value');

        updateMap(selectedScale, selectedYear, selectedSubject, selectedCategory)
      })

      updateMap('Relative', '2023', 'ELA', 'School Total')

    }).catch(function (error) {
      console.error(error);
    })

  </script>

</body>

</html>